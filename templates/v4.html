import React, { useState, useEffect, useRef, memo, useMemo } from 'react';
import { 
  Menu, Plus, MessageSquare, Settings, Mic, Image as ImageIcon, 
  Send, X, Moon, Sun, MoreVertical, Sparkles, User, Cpu, 
  ChevronRight, Info, History, Share, ThumbsUp, ThumbsDown, Copy, 
  Layout, FileCode, HardDrive, Zap, ChevronDown, Check, Loader2, Maximize2, Brain,
  Wrench, Globe, Video, BookOpen, FlaskConical, Hash, AtSign, FileText, Code,
  Monitor, Smartphone, ToggleLeft, ToggleRight, Palette, Layers, Shield,
  PenTool, Hammer, Search 
} from 'lucide-react';

// --- 核心架构：流式协议抽象层 (Streaming Abstraction Layer) ---

// 1. 定义统一的输入接口
interface StreamRequest {
    modelId: string;
    messages: Message[];
    config: {
        temperature?: number;
        useThinking?: boolean;
    };
}

// 2. 定义流式回调接口
interface StreamCallbacks {
    onStart?: () => void;
    onThinking?: (token: string) => void; // 思维链 Token
    onContent?: (token: string) => void;  // 正文 Token
    onEnd?: () => void;
    onError?: (err: Error) => void;
}

// 3. 协议适配器基类
abstract class StreamAdapter {
    abstract connect(request: StreamRequest, callbacks: StreamCallbacks): void;
    abstract disconnect(): void;
}

// 4. Mock 适配器 (模拟真实后端行为)
class MockStreamAdapter extends StreamAdapter {
    private aborted = false;

    connect(request: StreamRequest, callbacks: StreamCallbacks) {
        this.aborted = false;
        callbacks.onStart?.();

        const processMock = async () => {
            // 模拟网络延迟
            await new Promise(r => setTimeout(r, 600));
            if (this.aborted) return;

            // 阶段一：思维链 (如果启用)
            if (request.config.useThinking) {
                const thoughts = this.generateThoughts(request.messages[request.messages.length - 1].content);
                const thoughtTokens = thoughts.split(/(?=[^])/g); // Split by char preserving emojis
                
                for (const token of thoughtTokens) {
                    if (this.aborted) return;
                    await new Promise(r => setTimeout(r, 10 + Math.random() * 20));
                    callbacks.onThinking?.(token);
                }
                // 思考完成后的停顿
                await new Promise(r => setTimeout(r, 500));
            }

            // 阶段二：正文生成
            const response = this.generateResponse(request.messages[request.messages.length - 1].content, request.modelId);
            const contentTokens = response.split(/(?=[^])/g);

            for (const token of contentTokens) {
                if (this.aborted) return;
                await new Promise(r => setTimeout(r, 5 + Math.random() * 15));
                callbacks.onContent?.(token);
            }

            callbacks.onEnd?.();
        };

        processMock().catch(e => callbacks.onError?.(e));
    }

    disconnect() {
        this.aborted = true;
    }

    // 模拟服务端逻辑
    private generateThoughts(query: string): string {
        const q = query.toLowerCase();
        if (q.includes('react') || q.includes('code')) {
            return `1. Analyze Request: User asks about code/React.\n2. Knowledge Retrieval: Fetching React 19 hooks patterns.\n3. Safety Check: Code is safe to generate.\n4. Drafting: Structuring the component with TypeScript.`;
        }
        return `1. Intent Recognition: Analyzing "${query}".\n2. Context Search: Checking relevant knowledge bases.\n3. Reasoning: Formulating a comprehensive answer.\n4. Formatting: Ensuring markdown output.`;
    }

    private generateResponse(query: string, model: string): string {
        if (query.includes('code')) {
            return `Here is a **React** example using the requested pattern:\n\n\`\`\`tsx\nfunction Counter() {\n  const [count, setCount] = useState(0);\n  return <button onClick={() => setCount(c => c+1)}>{count}</button>;\n}\n\`\`\`\n\nGenerated by ${model}.`;
        }
        return `This is a simulated response for "${query}".\n\nI am running on the **${model}** architecture. The system just simulated a full streaming process including a "Thinking" phase (if enabled) followed by the content stream.`;
    }
}

// 5. SSE 适配器 (骨架示例)
class SSEStreamAdapter extends StreamAdapter {
    private eventSource: EventSource | null = null;

    connect(request: StreamRequest, callbacks: StreamCallbacks) {
        // 在真实场景中，这里会构建 URL 并附加参数
        // const url = `/api/stream?model=${request.modelId}...`;
        // this.eventSource = new EventSource(url);
        // this.eventSource.onmessage = (e) => { ...解析数据并调用回调... }
        console.log("SSE Adapter would connect here");
    }
    disconnect() {
        this.eventSource?.close();
    }
}

// 6. WebSocket 适配器 (骨架示例)
class WebSocketStreamAdapter extends StreamAdapter {
    private socket: WebSocket | null = null;

    connect(request: StreamRequest, callbacks: StreamCallbacks) {
        // this.socket = new WebSocket('wss://api.gemini.clone/ws');
        // this.socket.send(JSON.stringify(request));
        // this.socket.onmessage = (e) => { ... }
        console.log("WebSocket Adapter would connect here");
    }
    disconnect() {
        this.socket?.close();
    }
}

// 7. 统一流式客户端 (Stream Client Factory)
class StreamClient {
    private adapter: StreamAdapter;

    constructor(protocol: 'mock' | 'sse' | 'websocket' = 'mock') {
        switch (protocol) {
            case 'sse': this.adapter = new SSEStreamAdapter(); break;
            case 'websocket': this.adapter = new WebSocketStreamAdapter(); break;
            default: this.adapter = new MockStreamAdapter(); break;
        }
    }

    stream(request: StreamRequest, callbacks: StreamCallbacks) {
        this.adapter.connect(request, callbacks);
    }

    abort() {
        this.adapter.disconnect();
    }
}

// --- 这里的类型定义和之前的 UI 组件保持一致 ---
type Role = 'user' | 'model';

interface Message {
  id: string;
  role: Role;
  content: string;
  timestamp: number;
  isStreaming?: boolean;
  isThinking?: boolean;
  modelUsed?: string;
  thoughtProcess?: string;
}

interface ChatSession {
  id: string;
  title: string;
  messages: Message[];
  date: string;
}

interface TriggerItem {
    id: string;
    label: string;
    icon: React.ReactNode;
    description?: string;
}

interface UserSettings {
    theme: 'light' | 'dark';
    mode: 'general' | 'developer' | 'writer';
    enableThinking: boolean;
    enableTools: boolean;
    denseMode: boolean;
    safetyLevel: 'low' | 'medium' | 'high';
    protocol: 'mock' | 'sse' | 'websocket'; // 新增协议设置
}

// 默认设置
const DEFAULT_SETTINGS: UserSettings = {
    theme: 'dark', 
    mode: 'developer',
    enableThinking: true,
    enableTools: true,
    denseMode: false,
    safetyLevel: 'medium',
    protocol: 'mock'
};

// --- 静态数据 ---
const MENTIONS_LIST: TriggerItem[] = [
    { id: 'gemini', label: 'Gemini', icon: <Sparkles size={14} className="text-blue-500 dark:text-blue-400"/>, description: 'Default Model' },
    { id: 'docs', label: 'Google Docs', icon: <FileText size={14} className="text-blue-600 dark:text-blue-500"/>, description: 'Search documents' },
    { id: 'python', label: 'Python', icon: <Code size={14} className="text-yellow-600 dark:text-yellow-500"/>, description: 'Run code' },
    { id: 'drive', label: 'Drive', icon: <HardDrive size={14} className="text-green-600 dark:text-green-500"/>, description: 'Access files' },
];

const TAGS_LIST: TriggerItem[] = [
    { id: 'react', label: 'React', icon: <Zap size={14} className="text-cyan-500 dark:text-cyan-400"/>, description: 'Framework' },
    { id: 'summary', label: 'Summary', icon: <FileCode size={14} className="text-orange-500 dark:text-orange-400"/>, description: 'Summarize' },
    { id: 'bugfix', label: 'BugFix', icon: <Wrench size={14} className="text-red-500 dark:text-red-400"/>, description: 'Debug' },
];

const SUGGESTION_CHIPS = [
    { label: 'Create Image', icon: <ImageIcon size={16} className="text-yellow-500" />, action: 'image' },
    { label: 'Write', icon: <PenTool size={16} className="text-purple-500" />, action: 'write' },
    { label: 'Build', icon: <Hammer size={16} className="text-blue-500" />, action: 'code' },
    { label: 'Deep Research', icon: <Globe size={16} className="text-green-500" />, action: 'research' },
    { label: 'Create Video', icon: <Video size={16} className="text-red-500" />, action: 'video' },
    { label: 'Learn', icon: <BookOpen size={16} className="text-orange-500" />, action: 'learn' },
];

const MOCK_SESSIONS: ChatSession[] = [
  { id: '1', title: 'React Hooks 最佳实践', date: '今天', messages: [] },
  { id: '2', title: '科幻小说大纲构思', date: '昨天', messages: [] },
];

// --- 工具组件 ---

const SimpleMarkdown = memo(({ content }: { content: string }) => {
  const parts = content.split(/(```[\s\S]*?```)/g);
  return (
    <div className="markdown-body text-[15px] md:text-[16px] leading-7 font-light text-gray-800 dark:text-gray-200">
      {parts.map((part, index) => {
        if (part.startsWith('```')) {
          const lines = part.split('\n');
          const lang = lines[0].replace('```', '').trim();
          const code = lines.slice(1, -1).join('\n');
          return (
            <div key={index} className="my-4 rounded-xl overflow-hidden bg-gray-50 dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043]">
              <div className="flex justify-between items-center px-4 py-2 bg-gray-200 dark:bg-[#2d2e30] text-xs text-gray-600 dark:text-gray-400">
                <span className="font-mono">{lang || 'code'}</span>
                <div className="flex items-center gap-2 cursor-pointer hover:text-gray-900 dark:hover:text-white transition-colors">
                    <Copy size={12} />
                    <span>Copy</span>
                </div>
              </div>
              <div className="p-4 overflow-x-auto">
                <pre className="font-mono text-sm text-blue-700 dark:text-[#a8c7fa]"><code>{code}</code></pre>
              </div>
            </div>
          );
        }
        const textParts = part.split(/(\*\*.*?\*\*)/g);
        return (
          <span key={index}>
            {textParts.map((t, i) => {
              if (t.startsWith('**') && t.endsWith('**')) return <strong key={i} className="font-medium text-gray-900 dark:text-gray-100">{t.slice(2, -2)}</strong>;
              return t.split('\n').map((line, j) => <React.Fragment key={`${i}-${j}`}>{line}{j < t.split('\n').length - 1 && <br />}</React.Fragment>);
            })}
          </span>
        );
      })}
    </div>
  );
});

const MessageItem = memo(({ msg }: { msg: Message }) => {
  const [isThoughtOpen, setThoughtOpen] = useState(false);
  useEffect(() => { if (msg.isThinking) setThoughtOpen(true); }, [msg.isThinking]);

  return (
    <div className="group flex gap-4 animate-fade-in w-full max-w-3xl mx-auto">
      <div className="shrink-0 mt-1">
        {msg.role === 'model' ? (
          <div className="w-8 h-8 rounded-full flex items-center justify-center">
             <Sparkles className={`animate-pulse ${msg.modelUsed?.includes('Thinking') ? 'text-blue-500 dark:text-blue-400' : 'text-red-500 dark:text-red-400'}`} size={20} />
          </div>
        ) : (
          <div className="w-8 h-8 rounded-full bg-gray-200 dark:bg-[#3c4043] flex items-center justify-center">
             <User size={16} className="text-gray-600 dark:text-gray-300" />
          </div>
        )}
      </div>
      <div className="flex-1 min-w-0 space-y-2">
        <div className="flex items-center gap-2">
          <span className="font-medium text-sm text-gray-700 dark:text-gray-300">{msg.role === 'model' ? 'Gemini' : 'You'}</span>
          {msg.role === 'model' && msg.modelUsed && (
            <span className="text-[10px] px-1.5 py-0.5 rounded border border-gray-300 dark:border-gray-700 text-gray-500">{msg.modelUsed}</span>
          )}
        </div>
        
        {msg.role === 'model' && msg.thoughtProcess && (
          <div className="mb-3 rounded-xl bg-gray-50 dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043]/60 overflow-hidden">
             <button onClick={() => setThoughtOpen(!isThoughtOpen)} className="w-full flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-[#252627] hover:bg-gray-200 dark:hover:bg-[#2d2e30] transition-colors text-left">
                {isThoughtOpen ? <ChevronDown size={14} className="text-gray-500"/> : <ChevronRight size={14} className="text-gray-500"/>}
                <div className="flex items-center gap-1.5 text-xs font-medium text-gray-600 dark:text-gray-400">
                   <Brain size={12} className={msg.isThinking ? "text-blue-500 dark:text-blue-400 animate-pulse" : "text-gray-500"}/>
                   <span>Thinking Process</span>
                </div>
                {msg.isThinking && <span className="ml-auto flex items-center gap-1 text-[10px] text-blue-600/80 dark:text-blue-400/80 font-mono">Thinking <Loader2 size={10} className="animate-spin"/></span>}
             </button>
             {isThoughtOpen && (
               <div className="px-4 py-3 text-xs text-gray-700 dark:text-gray-300 font-mono leading-relaxed border-t border-gray-200 dark:border-[#3c4043]/30 bg-white dark:bg-[#1a1b1c] animate-slide-down">
                  {msg.thoughtProcess}
                  {msg.isThinking && <span className="inline-block w-1.5 h-3 bg-blue-500/50 ml-1 animate-pulse align-middle"></span>}
               </div>
             )}
          </div>
        )}

        <div className={`prose max-w-none dark:prose-invert prose-p:leading-relaxed prose-pre:bg-gray-100 dark:prose-pre:bg-[#1e1f20]`}>
           {msg.role === 'user' ? <div className="whitespace-pre-wrap text-gray-800 dark:text-[#e3e3e3] text-[16px]">{msg.content}</div> : <SimpleMarkdown content={msg.content} />}
           {msg.isStreaming && !msg.isThinking && <span className="inline-block w-2 h-4 bg-gray-800 dark:bg-gray-400 ml-1 animate-blink align-middle"></span>}
        </div>
      </div>
    </div>
  );
});

const SettingsModal = ({ isOpen, onClose, settings, updateSettings }: { isOpen: boolean; onClose: () => void; settings: UserSettings; updateSettings: (k: keyof UserSettings, v: any) => void; }) => {
    if (!isOpen) return null;
    const tabs = [{ id: 'general', label: 'General', icon: <Settings size={16}/> }, { id: 'features', label: 'Features', icon: <Layers size={16}/> }, { id: 'interface', label: 'Interface', icon: <Palette size={16}/> }];
    const [activeTab, setActiveTab] = useState('general');

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in text-gray-900 dark:text-gray-100">
            <div className="w-full max-w-2xl bg-white dark:bg-[#1e1f20] rounded-2xl shadow-2xl border border-gray-200 dark:border-[#3c4043] overflow-hidden flex flex-col md:flex-row h-[500px] md:h-[600px]">
                <div className="w-full md:w-60 bg-gray-50 dark:bg-[#252627] border-b md:border-b-0 md:border-r border-gray-200 dark:border-[#3c4043] p-4 flex flex-col">
                    <h2 className="text-lg font-medium text-gray-800 dark:text-gray-200 mb-6 px-2">Settings</h2>
                    <div className="space-y-1">{tabs.map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === tab.id ? 'bg-gray-200 dark:bg-[#3c4043] text-gray-900 dark:text-white' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#3c4043]/50'}`}>{tab.icon}<span>{tab.label}</span></button>))}</div>
                </div>
                <div className="flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-[#1e1f20]">
                    <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-[#3c4043]"><h3 className="text-xl font-medium text-gray-800 dark:text-gray-100">{tabs.find(t => t.id === activeTab)?.label}</h3><button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-[#3c4043] rounded-full text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors"><X size={20} /></button></div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                        {activeTab === 'general' && (
                            <div className="space-y-6">
                                <div className="space-y-4"><label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Protocol (Tech)</label><div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]"><div className="flex items-center gap-3"><Monitor size={20} className="text-gray-400"/><div><div className="text-sm font-medium text-gray-800 dark:text-gray-200">Streaming Protocol</div><div className="text-xs text-gray-500">Backend communication method</div></div></div><select value={settings.protocol} onChange={(e) => updateSettings('protocol', e.target.value)} className="bg-white dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043] text-gray-700 dark:text-gray-300 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500"><option value="mock">Mock (Simulated)</option><option value="sse">Server-Sent Events</option><option value="websocket">WebSocket</option></select></div></div>
                                <div className="space-y-4"><label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Usage Mode</label><div className="grid grid-cols-1 md:grid-cols-3 gap-3">{[{ id: 'general', label: 'General', desc: 'Standard experience' }, { id: 'developer', label: 'Developer', desc: 'Code & Tools focused' }, { id: 'writer', label: 'Creative', desc: 'Minimalist interface' }].map((mode) => (<button key={mode.id} onClick={() => updateSettings('mode', mode.id)} className={`p-4 rounded-xl border text-left transition-all ${settings.mode === mode.id ? 'bg-blue-50 dark:bg-[#004a77] border-blue-200 dark:border-[#7fcfff] text-blue-700 dark:text-[#c2e7ff]' : 'bg-gray-50 dark:bg-[#28292a] border-gray-200 dark:border-[#3c4043] text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500'}`}><div className="font-medium text-sm">{mode.label}</div><div className="text-xs opacity-70 mt-1">{mode.desc}</div></button>))}</div></div>
                            </div>
                        )}
                        {activeTab === 'features' && (
                            <div className="space-y-6">
                                <div className="space-y-4"><label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Capabilities</label><div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]"><div className="flex items-center gap-3"><Brain size={20} className="text-blue-500 dark:text-blue-400"/><div><div className="text-sm font-medium text-gray-800 dark:text-gray-200">Thinking Process</div><div className="text-xs text-gray-500">Show internal reasoning</div></div></div><button onClick={() => updateSettings('enableThinking', !settings.enableThinking)} className={`text-2xl ${settings.enableThinking ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-600'}`}>{settings.enableThinking ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}</button></div><div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]"><div className="flex items-center gap-3"><Wrench size={20} className="text-green-500 dark:text-green-400"/><div><div className="text-sm font-medium text-gray-800 dark:text-gray-200">Advanced Tools</div><div className="text-xs text-gray-500">Enable Deep Research, etc</div></div></div><button onClick={() => updateSettings('enableTools', !settings.enableTools)} className={`text-2xl ${settings.enableTools ? 'text-green-500 dark:text-green-400' : 'text-gray-400 dark:text-gray-600'}`}>{settings.enableTools ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}</button></div></div>
                            </div>
                        )}
                        {activeTab === 'interface' && (
                            <div className="space-y-6">
                                <div className="space-y-4"><label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Theme & Layout</label><div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]"><div className="flex items-center gap-3">{settings.theme === 'dark' ? <Moon size={20} className="text-purple-500 dark:text-purple-400"/> : <Sun size={20} className="text-yellow-500 dark:text-yellow-400"/>}<div><div className="text-sm font-medium text-gray-800 dark:text-gray-200">Dark Mode</div><div className="text-xs text-gray-500">Toggle theme</div></div></div><button onClick={() => updateSettings('theme', settings.theme === 'dark' ? 'light' : 'dark')} className={`text-2xl ${settings.theme === 'dark' ? 'text-purple-500 dark:text-purple-400' : 'text-gray-400 dark:text-gray-600'}`}>{settings.theme === 'dark' ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}</button></div><div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]"><div className="flex items-center gap-3"><Monitor size={20} className="text-orange-500 dark:text-orange-400"/><div><div className="text-sm font-medium text-gray-800 dark:text-gray-200">Compact Density</div><div className="text-xs text-gray-500">Reduce spacing</div></div></div><button onClick={() => updateSettings('denseMode', !settings.denseMode)} className={`text-2xl ${settings.denseMode ? 'text-orange-500 dark:text-orange-400' : 'text-gray-400 dark:text-gray-600'}`}>{settings.denseMode ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}</button></div></div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- 主组件 ---
export default function GeminiClone() {
  const [settings, setSettings] = useState<UserSettings>(DEFAULT_SETTINGS);
  const [isSettingsOpen, setSettingsOpen] = useState(false);
  const [isSidebarOpen, setSidebarOpen] = useState(true);
  
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const [sessions, setSessions] = useState<ChatSession[]>(MOCK_SESSIONS);
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  
  const isHome = messages.length === 0;

  const [isModelDropdownOpen, setModelDropdownOpen] = useState(false);
  const [isPlusMenuOpen, setPlusMenuOpen] = useState(false);
  const [isToolsMenuOpen, setToolsMenuOpen] = useState(false);
  const [showCanvasBadge, setShowCanvasBadge] = useState(true);

  const [triggerType, setTriggerType] = useState<'@' | '#' | null>(null);
  const [triggerQuery, setTriggerQuery] = useState('');

  const chatEndRef = useRef<HTMLDivElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const plusMenuRef = useRef<HTMLDivElement>(null);
  const toolsMenuRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);
  
  // 保持 StreamClient 的引用，避免每次渲染都重建
  const streamClientRef = useRef<StreamClient | null>(null);

  // 初始化 StreamClient
  useEffect(() => {
      streamClientRef.current = new StreamClient(settings.protocol);
  }, [settings.protocol]);

  const availableModels = useMemo(() => {
      const base = [{ id: 'fast', name: 'Fast', description: 'Answers quickly', icon: <Zap size={16} className="text-yellow-500 dark:text-yellow-400"/> }];
      if (settings.enableThinking) {
          base.push({ id: 'thinking', name: 'Thinking with 3 Pro', description: 'Deep reasoning capabilities', icon: <Sparkles size={16} className="text-blue-500 dark:text-blue-400"/> });
      }
      return base;
  }, [settings.enableThinking]);

  const [selectedModel, setSelectedModel] = useState(availableModels[0]);

  useEffect(() => {
      if (!settings.enableThinking && selectedModel.id === 'thinking') {
          setSelectedModel(availableModels[0]);
      }
  }, [settings.enableThinking, availableModels, selectedModel.id]);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', settings.theme === 'dark');
  }, [settings.theme]);

  useEffect(() => {
    if (messages.length > 0) chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages.length, isGenerating]);

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) setModelDropdownOpen(false);
      if (plusMenuRef.current && !plusMenuRef.current.contains(event.target as Node)) setPlusMenuOpen(false);
      if (toolsMenuRef.current && !toolsMenuRef.current.contains(event.target as Node)) setToolsMenuOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleUpdateSettings = (key: keyof UserSettings, value: any) => {
      setSettings(prev => {
          const newSettings = { ...prev, [key]: value };
          if (key === 'mode') {
              if (value === 'writer') { newSettings.enableTools = false; newSettings.denseMode = false; }
              else if (value === 'developer') { newSettings.enableTools = true; newSettings.denseMode = true; }
              else { newSettings.enableTools = true; newSettings.denseMode = false; }
          }
          return newSettings;
      });
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newVal = e.target.value;
    setInput(newVal);
    const cursorIndex = e.target.selectionStart;
    const textBeforeCursor = newVal.slice(0, cursorIndex);
    const match = textBeforeCursor.match(/([@#])([\w\u4e00-\u9fa5]*)$/);
    if (match) { setTriggerType(match[1] as '@' | '#'); setTriggerQuery(match[2]); } 
    else { setTriggerType(null); setTriggerQuery(''); }
  };

  const handleTriggerSelect = (item: TriggerItem) => {
    if (!triggerType) return;
    const cursorIndex = inputRef.current?.selectionStart || 0;
    const textBeforeCursor = input.slice(0, cursorIndex);
    const triggerIndex = textBeforeCursor.lastIndexOf(triggerType);
    const beforeTrigger = input.slice(0, triggerIndex);
    const afterTrigger = input.slice(cursorIndex);
    const newText = `${beforeTrigger}${triggerType}${item.label} ${afterTrigger}`;
    setInput(newText);
    setTriggerType(null);
    setTriggerQuery('');
    inputRef.current?.focus();
  };

  const getFilteredTriggers = () => {
    const list = triggerType === '@' ? MENTIONS_LIST : TAGS_LIST;
    return list.filter(item => item.label.toLowerCase().includes(triggerQuery.toLowerCase()));
  };

  const handleNewChat = () => {
    streamClientRef.current?.abort(); // 中断可能正在进行的请求
    setCurrentSessionId(null);
    setMessages([]);
    setInput('');
    if (window.innerWidth < 768) setSidebarOpen(false);
  };

  const handleSend = async (txt?: string) => {
    const textToSend = txt || input;
    if (!textToSend.trim() || isGenerating) return;
    
    // 确保流式客户端已初始化
    if (!streamClientRef.current) streamClientRef.current = new StreamClient(settings.protocol);

    setTriggerType(null);
    const userMsg: Message = { id: Date.now().toString(), role: 'user', content: textToSend, timestamp: Date.now() };
    
    // 乐观更新 UI
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsGenerating(true);

    const aiMsgId = (Date.now() + 1).toString();
    const isThinkingModel = selectedModel.id === 'thinking';

    // 初始化 AI 回复的占位
    setMessages(prev => [...prev, {
      id: aiMsgId, role: 'model', content: '', timestamp: Date.now(), isStreaming: true,
      isThinking: isThinkingModel, modelUsed: selectedModel.name, thoughtProcess: isThinkingModel ? '' : undefined
    }]);

    // 构建请求对象
    const request: StreamRequest = {
        modelId: selectedModel.name,
        messages: [...messages, userMsg],
        config: {
            useThinking: isThinkingModel
        }
    };

    // 定义回调
    const callbacks: StreamCallbacks = {
        onThinking: (token) => {
            setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, thoughtProcess: (m.thoughtProcess || '') + token } : m));
        },
        onContent: (token) => {
            // 确保如果之前的状态是 thinking，现在切换到正文 streaming
            setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, isThinking: false, content: m.content + token } : m));
        },
        onEnd: () => {
            setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, isStreaming: false, isThinking: false } : m));
            setIsGenerating(false);
        },
        onError: (err) => {
            setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, content: m.content + `\n[Error: ${err.message}]`, isStreaming: false } : m));
            setIsGenerating(false);
        }
    };

    // 启动流式传输
    streamClientRef.current.stream(request, callbacks);
  };

  const messageSpacing = settings.denseMode ? 'gap-2 py-2' : 'gap-6 py-6';
  const sidebarWidth = isSidebarOpen ? (settings.denseMode ? 'w-[220px]' : 'w-[260px]') : 'w-0';

  return (
    <div className={`flex h-screen w-full font-sans overflow-hidden bg-white dark:bg-[#131314] text-gray-900 dark:text-gray-100 selection:bg-blue-500/30 ${settings.denseMode ? 'text-sm' : ''}`}>
      
      {/* Sidebar */}
      <aside className={`flex flex-col h-full bg-[#f0f4f9] dark:bg-[#1e1f20] transition-all duration-300 ease-in-out z-30 border-r border-gray-200 dark:border-[#3c4043]/50 ${sidebarWidth} ${!isSidebarOpen && 'opacity-0 overflow-hidden'}`}>
        
        {/* Sidebar Header with Menu Collapse Button */}
        <div className="p-4 pt-4 flex items-center justify-between">
           <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-200 dark:hover:bg-[#3c4043] rounded-full transition-colors">
              <Menu size={20} className="text-gray-500 dark:text-gray-400"/>
           </button>
        </div>

        <div className="px-4 pb-4">
          <button onClick={handleNewChat} className="flex items-center gap-3 w-full py-3 px-4 rounded-full bg-[#dde3ea] dark:bg-[#28292a] hover:bg-[#d1d9e0] dark:hover:bg-[#37393b] text-[#444746] dark:text-[#e3e3e3] text-sm font-medium transition-colors mb-6">
            <Plus size={18} className="text-gray-500 dark:text-gray-400" />
            <span>New Chat</span>
          </button>
          <div className="space-y-1">
             <div className="px-4 py-2 text-[11px] font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Recent</div>
             {sessions.map(s => (
               <button key={s.id} onClick={() => {}} className={`group flex items-center gap-3 w-full p-2 px-3 rounded-full text-sm text-left transition-colors relative hover:bg-gray-200 dark:hover:bg-[#28292a] text-gray-700 dark:text-[#e3e3e3]`}>
                 <MessageSquare size={14} className="shrink-0 opacity-70" />
                 <span className="truncate flex-1">{s.title}</span>
               </button>
             ))}
          </div>
        </div>
        <div className="mt-auto p-4 border-t border-gray-200 dark:border-[#3c4043]/50">
            <button onClick={() => setSettingsOpen(true)} className="w-full flex items-center gap-3 px-2 py-2 text-sm text-gray-700 dark:text-[#e3e3e3] hover:bg-gray-200 dark:hover:bg-[#28292a] rounded-lg cursor-pointer transition-colors">
                <Settings size={16} className="text-gray-500 dark:text-gray-400"/>
                <span>Settings</span>
            </button>
             <div className="flex items-center gap-2 px-2 mt-4 text-[10px] text-gray-500"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span>Shanghai, CN</span></div>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col relative h-full w-full bg-white dark:bg-[#131314]">
        <header className="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-center bg-gradient-to-b from-white dark:from-[#131314] to-transparent pointer-events-none">
          <div className="pointer-events-auto">
             {/* Show expand button only if sidebar is closed */}
             {!isSidebarOpen && (
                 <button onClick={() => setSidebarOpen(true)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-[#28292a] text-gray-500 dark:text-gray-400 transition-colors">
                    <Menu size={20} />
                 </button>
             )}
            <span className={`text-lg font-medium text-gray-700 dark:text-gray-200 ml-2 ${isSidebarOpen ? 'opacity-0' : 'opacity-100 transition-opacity'}`}>Gemini</span>
          </div>
        </header>

        {/* Scrollable Chat Area */}
        <div className="flex-1 overflow-y-auto custom-scrollbar relative">
           {isHome ? (
             <div className="flex flex-col items-center justify-center h-full px-4 pb-32 animate-fade-in">
                <div className="mb-10 text-center">
                   <h1 className="text-5xl md:text-6xl font-medium text-transparent bg-clip-text bg-gradient-to-br from-blue-500 via-purple-500 to-red-500 mb-4 tracking-tight">Hello, User</h1>
                   <h2 className="text-4xl md:text-5xl font-medium text-[#444746] dark:text-[#5e5f61]">How can I help you today?</h2>
                </div>
                
                <div className="w-full h-32 md:h-40 pointer-events-none"></div>

                <div className="flex flex-wrap justify-center gap-3 mt-8 max-w-4xl">
                    {SUGGESTION_CHIPS.map((chip, idx) => (
                        <button 
                            key={idx} 
                            onClick={() => handleSend(chip.label)}
                            className="flex items-center gap-2 px-4 py-2.5 bg-gray-100 dark:bg-[#1e1f20] hover:bg-gray-200 dark:hover:bg-[#2d2e30] rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300 transition-all border border-transparent hover:border-gray-300 dark:hover:border-gray-600"
                        >
                            <span className="p-1 rounded-full bg-white dark:bg-black/20">{chip.icon}</span>
                            <span>{chip.label}</span>
                        </button>
                    ))}
                </div>
             </div>
           ) : (
             <div className="flex flex-col px-4 pt-20 pb-40 min-h-full justify-end">
                {messages.map(msg => (
                    <div key={msg.id} className={messageSpacing}>
                        <MessageItem msg={msg} />
                    </div>
                ))}
                <div ref={chatEndRef} />
             </div>
           )}
        </div>

        {/* Input Console - FIXED: Changed from fixed to absolute to respect sidebar layout */}
        <div className={`
            absolute left-0 w-full px-4 transition-all duration-500 ease-in-out z-20 pointer-events-none
            ${isHome 
               ? 'top-[50%] -translate-y-1/2' 
               : 'bottom-0 pb-6 pt-10 bg-gradient-to-t from-white dark:from-[#131314] via-white dark:via-[#131314] to-transparent'
            }
        `}>
           <div className={`pointer-events-auto max-w-3xl mx-auto relative group ${settings.denseMode ? 'max-w-4xl' : ''}`}>
              
              {/* Trigger Popup */}
              {triggerType && (
                  <div className="absolute bottom-full left-4 mb-2 w-64 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-xl shadow-2xl p-1 z-50 flex flex-col gap-0.5 animate-scale-up overflow-hidden">
                      <div className="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-200 dark:border-[#3c4043]/50 flex items-center gap-2">
                          {triggerType === '@' ? <AtSign size={12}/> : <Hash size={12}/>}
                          <span>{triggerType === '@' ? 'Mention' : 'Tag'}</span>
                      </div>
                      <div className="max-h-48 overflow-y-auto custom-scrollbar p-1">
                          {getFilteredTriggers().map((item) => (
                              <button key={item.id} onClick={() => handleTriggerSelect(item)} className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left">
                                  <div className="shrink-0">{item.icon}</div>
                                  <div className="flex-1 min-w-0">
                                      <div className="font-medium text-gray-900 dark:text-gray-200">{item.label}</div>
                                  </div>
                              </button>
                          ))}
                      </div>
                  </div>
              )}

              <div className="bg-[#f0f4f9] dark:bg-[#1e1f20] rounded-[28px] border border-gray-200 dark:border-[#3c4043] shadow-lg flex flex-col transition-colors focus-within:bg-white dark:focus-within:bg-[#252627] focus-within:border-gray-300 dark:focus-within:border-[#5e5f61]">
                 <div className={`flex items-start w-full px-4 ${settings.denseMode ? 'py-2 min-h-[48px]' : 'py-3 min-h-[56px]'}`}>
                    {settings.showCanvas && showCanvasBadge && (
                        <div className="shrink-0 flex items-center gap-1 bg-[#dde3ea] dark:bg-[#28292a] border border-gray-300 dark:border-[#3c4043] rounded-lg px-2 py-1 mr-2 mt-1 cursor-pointer hover:bg-gray-200 dark:hover:bg-[#333]">
                           <Maximize2 size={12} className="text-gray-500 dark:text-gray-400" />
                           <span className="text-xs text-gray-600 dark:text-gray-300">Canvas</span>
                           <button onClick={() => setShowCanvasBadge(false)} className="ml-1 hover:text-black dark:hover:text-white text-gray-400 dark:text-gray-500"><X size={10}/></button>
                        </div>
                    )}
                    <textarea 
                        ref={inputRef}
                        value={input}
                        onChange={handleInputChange}
                        onKeyDown={(e) => { 
                            if (e.key === 'Escape' && triggerType) setTriggerType(null);
                            if (e.key === 'Enter' && !e.shiftKey && !triggerType) { e.preventDefault(); handleSend(); }
                        }}
                        placeholder="Ask Gemini..."
                        className="flex-1 bg-transparent border-none outline-none text-gray-800 dark:text-[#e3e3e3] placeholder-gray-500 text-base resize-none py-1 max-h-[200px] custom-scrollbar"
                        rows={1}
                        style={{ minHeight: '24px' }}
                    />
                 </div>

                 <div className="flex items-center justify-between px-4 pb-3 pt-1">
                    <div className="flex items-center gap-2">
                        <div className="relative" ref={plusMenuRef}>
                            <button onClick={() => setPlusMenuOpen(!isPlusMenuOpen)} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-gray-900 dark:hover:text-white rounded-full transition-all"><Plus size={18} /></button>
                            {isPlusMenuOpen && (
                                <div className="absolute bottom-14 left-0 w-60 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up">
                                    {[ { icon: <HardDrive size={18} />, label: "Upload files" }, { icon: <ImageIcon size={18} />, label: "Photos" }].map((item, idx) => (
                                        <button key={idx} className="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left"><span className="text-gray-500 dark:text-gray-400">{item.icon}</span><span>{item.label}</span></button>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        {settings.enableTools && (
                            <div className="relative" ref={toolsMenuRef}>
                                <button onClick={() => setToolsMenuOpen(!isToolsMenuOpen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${isToolsMenuOpen ? 'bg-gray-200 dark:bg-[#3c4043] text-black dark:text-white' : 'bg-[#dde3ea] dark:bg-[#28292a] text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-black dark:hover:text-white'}`}><Wrench size={14} /><span>Tools</span></button>
                                {isToolsMenuOpen && (
                                    <div className="absolute bottom-14 left-0 w-64 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up">
                                        {[ { icon: <Globe size={16} />, label: "Deep Research" }, { icon: <Video size={16} />, label: "Create videos" } ].map((item, idx) => (
                                            <button key={idx} className="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left"><span className="text-gray-500 dark:text-gray-400">{item.icon}</span><span>{item.label}</span></button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="relative" ref={dropdownRef}>
                            <button onClick={() => setModelDropdownOpen(!isModelDropdownOpen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border ${selectedModel.id === 'thinking' ? 'bg-[#e8f0fe] dark:bg-[#18232c] border-blue-200 dark:border-[#294254] text-blue-700 dark:text-[#a8c7fa]' : 'bg-[#dde3ea] dark:bg-[#28292a] border-transparent text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043]'}`}>
                               {selectedModel.icon}
                               <span>{selectedModel.name}</span><ChevronDown size={12} className="opacity-70" />
                            </button>
                            {isModelDropdownOpen && (
                                <div className="absolute bottom-12 right-0 w-72 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up origin-bottom-right">
                                    <div className="px-3 py-2 text-xs font-medium text-gray-500">Choose your model</div>
                                    {availableModels.map(model => (
                                        <button key={model.id} onClick={() => { setSelectedModel(model); setModelDropdownOpen(false); }} className="flex items-start gap-3 px-3 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] transition-colors text-left group/item">
                                            <div className="mt-1">{model.icon}</div>
                                            <div className="flex-1"><div className="flex items-center justify-between"><span className={`text-sm font-medium ${selectedModel.id === model.id ? 'text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300'}`}>{model.name}</span>{selectedModel.id === model.id && <Check size={14} className="text-blue-500 dark:text-blue-400"/>}</div><div className="text-xs text-gray-500 mt-0.5">{model.description}</div></div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                        <button className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-gray-900 dark:hover:text-white rounded-full transition-colors"><Mic size={20} /></button>
                        <button onClick={() => handleSend()} className={`p-2 rounded-full transition-colors ${input.trim() ? 'bg-blue-600 dark:bg-[#a8c7fa] text-white dark:text-[#0b1219] hover:bg-blue-700 dark:hover:bg-white' : 'bg-[#dde3ea] dark:bg-[#3c4043] text-gray-400 dark:text-gray-500 cursor-not-allowed'}`}><Send size={18} className="ml-0.5" /></button>
                    </div>
                 </div>
              </div>
           </div>
        </div>

        <SettingsModal isOpen={isSettingsOpen} onClose={() => setSettingsOpen(false)} settings={settings} updateSettings={handleUpdateSettings}/>
      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3c4043; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; height: 0; } to { opacity: 1; height: auto; } }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-scale-up { animation: scaleUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      `}</style>
    </div>
  );
}