import React, { useState, useEffect, useRef, memo, useMemo } from 'react';
import { 
  Menu, Plus, MessageSquare, Settings, Mic, Image as ImageIcon, 
  Send, X, Moon, Sun, MoreVertical, Sparkles, User, Cpu, 
  ChevronRight, Info, History, Share, ThumbsUp, ThumbsDown, Copy, 
  Layout, FileCode, HardDrive, Zap, ChevronDown, Check, Loader2, Maximize2, Brain,
  Wrench, Globe, Video, BookOpen, FlaskConical, Hash, AtSign, FileText, Code,
  Monitor, Smartphone, ToggleLeft, ToggleRight, Palette, Layers, Shield
} from 'lucide-react';

// --- 类型定义 ---
type Role = 'user' | 'model';

interface Message {
  id: string;
  role: Role;
  content: string;
  timestamp: number;
  isStreaming?: boolean;
  isThinking?: boolean;
  modelUsed?: string;
  thoughtProcess?: string;
}

interface ChatSession {
  id: string;
  title: string;
  messages: Message[];
  date: string;
}

interface TriggerItem {
    id: string;
    label: string;
    icon: React.ReactNode;
    description?: string;
}

interface UserSettings {
    theme: 'light' | 'dark';
    mode: 'general' | 'developer' | 'writer'; // 场景模式
    enableThinking: boolean; // 功能开关：思维链
    enableTools: boolean;    // 功能开关：工具箱
    denseMode: boolean;      // 界面密度
    safetyLevel: 'low' | 'medium' | 'high';
}

// 默认设置
const DEFAULT_SETTINGS: UserSettings = {
    theme: 'dark', // 默认主题
    mode: 'developer',
    enableThinking: true,
    enableTools: true,
    denseMode: false,
    safetyLevel: 'medium'
};

// --- 静态数据 ---
// @ 提及列表
const MENTIONS_LIST: TriggerItem[] = [
    { id: 'gemini', label: 'Gemini', icon: <Sparkles size={14} className="text-blue-500 dark:text-blue-400"/>, description: 'Default Model' },
    { id: 'docs', label: 'Google Docs', icon: <FileText size={14} className="text-blue-600 dark:text-blue-500"/>, description: 'Search documents' },
    { id: 'python', label: 'Python', icon: <Code size={14} className="text-yellow-600 dark:text-yellow-500"/>, description: 'Run code' },
    { id: 'drive', label: 'Drive', icon: <HardDrive size={14} className="text-green-600 dark:text-green-500"/>, description: 'Access files' },
];

// # 标签列表
const TAGS_LIST: TriggerItem[] = [
    { id: 'react', label: 'React', icon: <Zap size={14} className="text-cyan-500 dark:text-cyan-400"/>, description: 'Framework' },
    { id: 'summary', label: 'Summary', icon: <FileCode size={14} className="text-orange-500 dark:text-orange-400"/>, description: 'Summarize' },
    { id: 'bugfix', label: 'BugFix', icon: <Wrench size={14} className="text-red-500 dark:text-red-400"/>, description: 'Debug' },
];

const MOCK_SESSIONS: ChatSession[] = [
  { id: '1', title: 'React Hooks 最佳实践', date: '今天', messages: [] },
  { id: '2', title: '科幻小说大纲构思', date: '昨天', messages: [] },
];

// --- 工具组件 ---

// 简易 Markdown
const SimpleMarkdown = memo(({ content }: { content: string }) => {
  const parts = content.split(/(```[\s\S]*?```)/g);
  return (
    <div className="markdown-body text-[15px] md:text-[16px] leading-7 font-light text-gray-800 dark:text-gray-200">
      {parts.map((part, index) => {
        if (part.startsWith('```')) {
          const lines = part.split('\n');
          const lang = lines[0].replace('```', '').trim();
          const code = lines.slice(1, -1).join('\n');
          return (
            <div key={index} className="my-4 rounded-xl overflow-hidden bg-gray-50 dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043]">
              <div className="flex justify-between items-center px-4 py-2 bg-gray-200 dark:bg-[#2d2e30] text-xs text-gray-600 dark:text-gray-400">
                <span className="font-mono">{lang || 'code'}</span>
                <div className="flex items-center gap-2 cursor-pointer hover:text-gray-900 dark:hover:text-white transition-colors">
                    <Copy size={12} />
                    <span>Copy</span>
                </div>
              </div>
              <div className="p-4 overflow-x-auto">
                <pre className="font-mono text-sm text-blue-700 dark:text-[#a8c7fa]"><code>{code}</code></pre>
              </div>
            </div>
          );
        }
        const textParts = part.split(/(\*\*.*?\*\*)/g);
        return (
          <span key={index}>
            {textParts.map((t, i) => {
              if (t.startsWith('**') && t.endsWith('**')) return <strong key={i} className="font-medium text-gray-900 dark:text-gray-100">{t.slice(2, -2)}</strong>;
              return t.split('\n').map((line, j) => <React.Fragment key={`${i}-${j}`}>{line}{j < t.split('\n').length - 1 && <br />}</React.Fragment>);
            })}
          </span>
        );
      })}
    </div>
  );
});

// 消息组件
const MessageItem = memo(({ msg }: { msg: Message }) => {
  const [isThoughtOpen, setThoughtOpen] = useState(false);
  useEffect(() => { if (msg.isThinking) setThoughtOpen(true); }, [msg.isThinking]);

  return (
    <div className="group flex gap-4 animate-fade-in w-full max-w-3xl mx-auto">
      <div className="shrink-0 mt-1">
        {msg.role === 'model' ? (
          <div className="w-8 h-8 rounded-full flex items-center justify-center">
             <Sparkles className={`animate-pulse ${msg.modelUsed?.includes('Thinking') ? 'text-blue-500 dark:text-blue-400' : 'text-red-500 dark:text-red-400'}`} size={20} />
          </div>
        ) : (
          <div className="w-8 h-8 rounded-full bg-gray-200 dark:bg-[#3c4043] flex items-center justify-center">
             <User size={16} className="text-gray-600 dark:text-gray-300" />
          </div>
        )}
      </div>
      <div className="flex-1 min-w-0 space-y-2">
        <div className="flex items-center gap-2">
          <span className="font-medium text-sm text-gray-700 dark:text-gray-300">{msg.role === 'model' ? 'Gemini' : 'You'}</span>
          {msg.role === 'model' && msg.modelUsed && (
            <span className="text-[10px] px-1.5 py-0.5 rounded border border-gray-300 dark:border-gray-700 text-gray-500">{msg.modelUsed}</span>
          )}
        </div>
        
        {msg.role === 'model' && msg.thoughtProcess && (
          <div className="mb-3 rounded-xl bg-gray-50 dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043]/60 overflow-hidden">
             <button onClick={() => setThoughtOpen(!isThoughtOpen)} className="w-full flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-[#252627] hover:bg-gray-200 dark:hover:bg-[#2d2e30] transition-colors text-left">
                {isThoughtOpen ? <ChevronDown size={14} className="text-gray-500"/> : <ChevronRight size={14} className="text-gray-500"/>}
                <div className="flex items-center gap-1.5 text-xs font-medium text-gray-600 dark:text-gray-400">
                   <Brain size={12} className={msg.isThinking ? "text-blue-500 dark:text-blue-400 animate-pulse" : "text-gray-500"}/>
                   <span>Thinking Process</span>
                </div>
                {msg.isThinking && <span className="ml-auto flex items-center gap-1 text-[10px] text-blue-600/80 dark:text-blue-400/80 font-mono">Thinking <Loader2 size={10} className="animate-spin"/></span>}
             </button>
             {isThoughtOpen && (
               <div className="px-4 py-3 text-xs text-gray-700 dark:text-gray-300 font-mono leading-relaxed border-t border-gray-200 dark:border-[#3c4043]/30 bg-white dark:bg-[#1a1b1c] animate-slide-down">
                  {msg.thoughtProcess}
                  {msg.isThinking && <span className="inline-block w-1.5 h-3 bg-blue-500/50 ml-1 animate-pulse align-middle"></span>}
               </div>
             )}
          </div>
        )}

        <div className={`prose max-w-none dark:prose-invert prose-p:leading-relaxed prose-pre:bg-gray-100 dark:prose-pre:bg-[#1e1f20]`}>
           {msg.role === 'user' ? <div className="whitespace-pre-wrap text-gray-800 dark:text-[#e3e3e3] text-[16px]">{msg.content}</div> : <SimpleMarkdown content={msg.content} />}
           {msg.isStreaming && !msg.isThinking && <span className="inline-block w-2 h-4 bg-gray-800 dark:bg-gray-400 ml-1 animate-blink align-middle"></span>}
        </div>
      </div>
    </div>
  );
});

// 设置模态框组件
const SettingsModal = ({ 
    isOpen, 
    onClose, 
    settings, 
    updateSettings 
}: { 
    isOpen: boolean; 
    onClose: () => void; 
    settings: UserSettings; 
    updateSettings: (k: keyof UserSettings, v: any) => void;
}) => {
    if (!isOpen) return null;

    const tabs = [
        { id: 'general', label: 'General', icon: <Settings size={16}/> },
        { id: 'features', label: 'Features', icon: <Layers size={16}/> },
        { id: 'interface', label: 'Interface', icon: <Palette size={16}/> },
    ];
    const [activeTab, setActiveTab] = useState('general');

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in text-gray-900 dark:text-gray-100">
            <div className="w-full max-w-2xl bg-white dark:bg-[#1e1f20] rounded-2xl shadow-2xl border border-gray-200 dark:border-[#3c4043] overflow-hidden flex flex-col md:flex-row h-[500px] md:h-[600px]">
                {/* Sidebar */}
                <div className="w-full md:w-60 bg-gray-50 dark:bg-[#252627] border-b md:border-b-0 md:border-r border-gray-200 dark:border-[#3c4043] p-4 flex flex-col">
                    <h2 className="text-lg font-medium text-gray-800 dark:text-gray-200 mb-6 px-2">Settings</h2>
                    <div className="space-y-1">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === tab.id ? 'bg-gray-200 dark:bg-[#3c4043] text-gray-900 dark:text-white' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#3c4043]/50'}`}
                            >
                                {tab.icon}
                                <span>{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Content */}
                <div className="flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-[#1e1f20]">
                    <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-[#3c4043]">
                        <h3 className="text-xl font-medium text-gray-800 dark:text-gray-100">
                            {tabs.find(t => t.id === activeTab)?.label}
                        </h3>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-[#3c4043] rounded-full text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                            <X size={20} />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                        {activeTab === 'general' && (
                            <div className="space-y-6">
                                <div className="space-y-4">
                                    <label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Usage Mode</label>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        {[
                                            { id: 'general', label: 'General', desc: 'Standard experience' },
                                            { id: 'developer', label: 'Developer', desc: 'Code & Tools focused' },
                                            { id: 'writer', label: 'Creative', desc: 'Minimalist interface' }
                                        ].map((mode) => (
                                            <button 
                                                key={mode.id}
                                                onClick={() => updateSettings('mode', mode.id)}
                                                className={`p-4 rounded-xl border text-left transition-all ${settings.mode === mode.id ? 'bg-blue-50 dark:bg-[#004a77] border-blue-200 dark:border-[#7fcfff] text-blue-700 dark:text-[#c2e7ff]' : 'bg-gray-50 dark:bg-[#28292a] border-gray-200 dark:border-[#3c4043] text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500'}`}
                                            >
                                                <div className="font-medium text-sm">{mode.label}</div>
                                                <div className="text-xs opacity-70 mt-1">{mode.desc}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Safety</label>
                                    <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]">
                                        <div className="flex items-center gap-3">
                                            <Shield size={20} className="text-gray-400"/>
                                            <div>
                                                <div className="text-sm font-medium text-gray-800 dark:text-gray-200">Content Filtering</div>
                                                <div className="text-xs text-gray-500">Adjust sensitivity of content safety filters</div>
                                            </div>
                                        </div>
                                        <select 
                                            value={settings.safetyLevel}
                                            onChange={(e) => updateSettings('safetyLevel', e.target.value)}
                                            className="bg-white dark:bg-[#1e1f20] border border-gray-200 dark:border-[#3c4043] text-gray-700 dark:text-gray-300 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500"
                                        >
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'features' && (
                            <div className="space-y-6">
                                <div className="space-y-4">
                                    <label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Capabilities</label>
                                    
                                    <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]">
                                        <div className="flex items-center gap-3">
                                            <Brain size={20} className="text-blue-500 dark:text-blue-400"/>
                                            <div>
                                                <div className="text-sm font-medium text-gray-800 dark:text-gray-200">Thinking Process (CoT)</div>
                                                <div className="text-xs text-gray-500">Show internal reasoning steps before answering</div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateSettings('enableThinking', !settings.enableThinking)} className={`text-2xl ${settings.enableThinking ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-600'}`}>
                                            {settings.enableThinking ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}
                                        </button>
                                    </div>

                                    <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]">
                                        <div className="flex items-center gap-3">
                                            <Wrench size={20} className="text-green-500 dark:text-green-400"/>
                                            <div>
                                                <div className="text-sm font-medium text-gray-800 dark:text-gray-200">Advanced Tools</div>
                                                <div className="text-xs text-gray-500">Enable Deep Research, Python exec, and more</div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateSettings('enableTools', !settings.enableTools)} className={`text-2xl ${settings.enableTools ? 'text-green-500 dark:text-green-400' : 'text-gray-400 dark:text-gray-600'}`}>
                                            {settings.enableTools ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'interface' && (
                            <div className="space-y-6">
                                <div className="space-y-4">
                                    <label className="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Theme & Layout</label>
                                    
                                    <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]">
                                        <div className="flex items-center gap-3">
                                            {settings.theme === 'dark' ? <Moon size={20} className="text-purple-500 dark:text-purple-400"/> : <Sun size={20} className="text-yellow-500 dark:text-yellow-400"/>}
                                            <div>
                                                <div className="text-sm font-medium text-gray-800 dark:text-gray-200">Dark Mode</div>
                                                <div className="text-xs text-gray-500">Toggle application theme</div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateSettings('theme', settings.theme === 'dark' ? 'light' : 'dark')} className={`text-2xl ${settings.theme === 'dark' ? 'text-purple-500 dark:text-purple-400' : 'text-gray-400 dark:text-gray-600'}`}>
                                            {settings.theme === 'dark' ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}
                                        </button>
                                    </div>

                                    <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#28292a] rounded-xl border border-gray-200 dark:border-[#3c4043]">
                                        <div className="flex items-center gap-3">
                                            <Monitor size={20} className="text-orange-500 dark:text-orange-400"/>
                                            <div>
                                                <div className="text-sm font-medium text-gray-800 dark:text-gray-200">Compact Density</div>
                                                <div className="text-xs text-gray-500">Reduce spacing for high-density displays</div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateSettings('denseMode', !settings.denseMode)} className={`text-2xl ${settings.denseMode ? 'text-orange-500 dark:text-orange-400' : 'text-gray-400 dark:text-gray-600'}`}>
                                            {settings.denseMode ? <ToggleRight size={32}/> : <ToggleLeft size={32}/>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- 主组件 ---
export default function GeminiClone() {
  const [settings, setSettings] = useState<UserSettings>(DEFAULT_SETTINGS);
  const [isSettingsOpen, setSettingsOpen] = useState(false);
  const [isSidebarOpen, setSidebarOpen] = useState(true);
  
  // 聊天状态
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const [sessions, setSessions] = useState<ChatSession[]>(MOCK_SESSIONS);
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  
  // 菜单状态
  const [isModelDropdownOpen, setModelDropdownOpen] = useState(false);
  const [isPlusMenuOpen, setPlusMenuOpen] = useState(false);
  const [isToolsMenuOpen, setToolsMenuOpen] = useState(false);
  const [showCanvasBadge, setShowCanvasBadge] = useState(true);

  // Trigger Menu
  const [triggerType, setTriggerType] = useState<'@' | '#' | null>(null);
  const [triggerQuery, setTriggerQuery] = useState('');

  // Refs
  const chatEndRef = useRef<HTMLDivElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const plusMenuRef = useRef<HTMLDivElement>(null);
  const toolsMenuRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  // 动态计算可用模型
  const availableModels = useMemo(() => {
      const base = [{ id: 'fast', name: 'Fast', description: 'Answers quickly', icon: <Zap size={16} className="text-yellow-500 dark:text-yellow-400"/> }];
      if (settings.enableThinking) {
          base.push({ id: 'thinking', name: 'Thinking with 3 Pro', description: 'Deep reasoning capabilities', icon: <Sparkles size={16} className="text-blue-500 dark:text-blue-400"/> });
      }
      return base;
  }, [settings.enableThinking]);

  const [selectedModel, setSelectedModel] = useState(availableModels[0]);

  // 当 settings.enableThinking 变化时，如果当前选中的是 thinking，需要重置
  useEffect(() => {
      if (!settings.enableThinking && selectedModel.id === 'thinking') {
          setSelectedModel(availableModels[0]);
      }
  }, [settings.enableThinking, availableModels, selectedModel.id]);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', settings.theme === 'dark');
  }, [settings.theme]);

  useEffect(() => {
    if (messages.length > 0) chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages.length, isGenerating]);

  // 关闭菜单点击外部
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) setModelDropdownOpen(false);
      if (plusMenuRef.current && !plusMenuRef.current.contains(event.target as Node)) setPlusMenuOpen(false);
      if (toolsMenuRef.current && !toolsMenuRef.current.contains(event.target as Node)) setToolsMenuOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleUpdateSettings = (key: keyof UserSettings, value: any) => {
      setSettings(prev => {
          const newSettings = { ...prev, [key]: value };
          // 模式联动
          if (key === 'mode') {
              if (value === 'writer') {
                  newSettings.enableTools = false;
                  newSettings.denseMode = false;
              } else if (value === 'developer') {
                  newSettings.enableTools = true;
                  newSettings.denseMode = true;
              } else {
                  newSettings.enableTools = true;
                  newSettings.denseMode = false;
              }
          }
          return newSettings;
      });
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newVal = e.target.value;
    setInput(newVal);
    const cursorIndex = e.target.selectionStart;
    const textBeforeCursor = newVal.slice(0, cursorIndex);
    const match = textBeforeCursor.match(/([@#])([\w\u4e00-\u9fa5]*)$/);
    if (match) {
        setTriggerType(match[1] as '@' | '#');
        setTriggerQuery(match[2]);
    } else {
        setTriggerType(null);
        setTriggerQuery('');
    }
  };

  const handleTriggerSelect = (item: TriggerItem) => {
    if (!triggerType) return;
    const cursorIndex = inputRef.current?.selectionStart || 0;
    const textBeforeCursor = input.slice(0, cursorIndex);
    const triggerIndex = textBeforeCursor.lastIndexOf(triggerType);
    const beforeTrigger = input.slice(0, triggerIndex);
    const afterTrigger = input.slice(cursorIndex);
    const newText = `${beforeTrigger}${triggerType}${item.label} ${afterTrigger}`;
    setInput(newText);
    setTriggerType(null);
    setTriggerQuery('');
    inputRef.current?.focus();
  };

  const getFilteredTriggers = () => {
    const list = triggerType === '@' ? MENTIONS_LIST : TAGS_LIST;
    return list.filter(item => item.label.toLowerCase().includes(triggerQuery.toLowerCase()));
  };

  const handleSend = async () => {
    if (!input.trim() || isGenerating) return;
    setTriggerType(null);
    const userMsg: Message = { id: Date.now().toString(), role: 'user', content: input, timestamp: Date.now() };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsGenerating(true);

    const aiMsgId = (Date.now() + 1).toString();
    const isThinkingModel = selectedModel.id === 'thinking';

    setMessages(prev => [...prev, {
      id: aiMsgId, role: 'model', content: '', timestamp: Date.now(), isStreaming: true,
      isThinking: isThinkingModel, modelUsed: selectedModel.name, thoughtProcess: isThinkingModel ? '' : undefined
    }]);

    if (isThinkingModel) {
        const thoughts = "Thinking Process based on settings...";
        const thoughtChars = thoughts.split("");
        let currentThought = "";
        for (let i = 0; i < thoughtChars.length; i++) {
            await new Promise(r => setTimeout(r, 15));
            currentThought += thoughtChars[i];
            setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, thoughtProcess: currentThought } : m));
        }
        await new Promise(r => setTimeout(r, 400));
        setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, isThinking: false } : m));
    } else {
        await new Promise(r => setTimeout(r, 600));
    }

    const responseText = `Response to "${userMsg.content}" using ${selectedModel.name}.`;
    let currentText = "";
    const chars = responseText.split("");
    for (let i = 0; i < chars.length; i++) {
      await new Promise(r => setTimeout(r, 10));
      currentText += chars[i];
      setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, content: currentText } : m));
    }

    setMessages(prev => prev.map(m => m.id === aiMsgId ? { ...m, isStreaming: false } : m));
    setIsGenerating(false);
  };

  // 根据 denseMode 调整样式
  const messageSpacing = settings.denseMode ? 'gap-2 py-2' : 'gap-6 py-6';
  const sidebarWidth = isSidebarOpen ? (settings.denseMode ? 'w-[220px]' : 'w-[260px]') : 'w-0';

  return (
    <div className={`flex h-screen w-full font-sans overflow-hidden bg-white dark:bg-[#131314] text-gray-900 dark:text-gray-100 selection:bg-blue-500/30 ${settings.denseMode ? 'text-sm' : ''}`}>
      
      {/* Sidebar */}
      <aside className={`flex flex-col h-full bg-[#f0f4f9] dark:bg-[#1e1f20] transition-all duration-300 ease-in-out z-30 border-r border-gray-200 dark:border-[#3c4043]/50 ${sidebarWidth} ${!isSidebarOpen && 'opacity-0 overflow-hidden'}`}>
        <div className="p-4 pt-6">
          <button onClick={() => setSidebarOpen(false)} className="md:hidden mb-4 p-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"><X size={20} /></button>
          <button onClick={() => {}} className="flex items-center gap-3 w-full py-3 px-4 rounded-full bg-[#dde3ea] dark:bg-[#28292a] hover:bg-[#d1d9e0] dark:hover:bg-[#37393b] text-[#444746] dark:text-[#e3e3e3] text-sm font-medium transition-colors mb-6">
            <Plus size={18} className="text-gray-500 dark:text-gray-400" />
            <span>New Chat</span>
          </button>
          <div className="space-y-1">
             <div className="px-4 py-2 text-[11px] font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Recent</div>
             {sessions.map(s => (
               <button key={s.id} onClick={() => {}} className={`group flex items-center gap-3 w-full p-2 px-3 rounded-full text-sm text-left transition-colors relative hover:bg-gray-200 dark:hover:bg-[#28292a] text-gray-700 dark:text-[#e3e3e3]`}>
                 <MessageSquare size={14} className="shrink-0 opacity-70" />
                 <span className="truncate flex-1">{s.title}</span>
               </button>
             ))}
          </div>
        </div>
        <div className="mt-auto p-4 border-t border-gray-200 dark:border-[#3c4043]/50">
            <button onClick={() => setSettingsOpen(true)} className="w-full flex items-center gap-3 px-2 py-2 text-sm text-gray-700 dark:text-[#e3e3e3] hover:bg-gray-200 dark:hover:bg-[#28292a] rounded-lg cursor-pointer transition-colors">
                <Settings size={16} className="text-gray-500 dark:text-gray-400"/>
                <span>Settings</span>
            </button>
             <div className="flex items-center gap-2 px-2 mt-4 text-[10px] text-gray-500"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span>Shanghai, CN</span></div>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col relative h-full w-full bg-white dark:bg-[#131314]">
        <header className="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-center bg-gradient-to-b from-white dark:from-[#131314] to-transparent pointer-events-none">
          <div className="pointer-events-auto">
             {!isSidebarOpen && <button onClick={() => setSidebarOpen(true)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-[#28292a] text-gray-500 dark:text-gray-400 transition-colors"><Menu size={20} /></button>}
            <span className={`text-lg font-medium text-gray-700 dark:text-gray-200 ml-2 ${isSidebarOpen ? 'opacity-0' : 'opacity-100 transition-opacity'}`}>Gemini</span>
          </div>
        </header>

        <div className="flex-1 overflow-y-auto custom-scrollbar pt-20 pb-40">
           {messages.length === 0 ? (
             <div className="h-full flex flex-col items-center justify-center p-4 animate-fade-in text-center">
                <div className="mb-8">
                   <h1 className="text-4xl md:text-5xl font-medium text-transparent bg-clip-text bg-gradient-to-br from-blue-500 via-purple-500 to-red-500 mb-4">Hello, User</h1>
                   <h2 className="text-4xl md:text-5xl font-medium text-[#444746] dark:text-[#5e5f61]">Mode: {settings.mode}</h2>
                </div>
             </div>
           ) : (
             <div className="flex flex-col px-4">
                {messages.map(msg => (
                    <div key={msg.id} className={messageSpacing}>
                        <MessageItem msg={msg} />
                    </div>
                ))}
                <div ref={chatEndRef} />
             </div>
           )}
        </div>

        {/* Input Console */}
        <div className="absolute bottom-0 left-0 w-full pb-6 pt-10 px-4 bg-gradient-to-t from-white dark:from-[#131314] via-white dark:via-[#131314] to-transparent z-20">
           <div className={`max-w-3xl mx-auto relative group ${settings.denseMode ? 'max-w-4xl' : ''}`}>
              
              {/* Trigger Popup */}
              {triggerType && (
                  <div className="absolute bottom-full left-4 mb-2 w-64 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-xl shadow-2xl p-1 z-50 flex flex-col gap-0.5 animate-scale-up overflow-hidden">
                      <div className="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-200 dark:border-[#3c4043]/50 flex items-center gap-2">
                          {triggerType === '@' ? <AtSign size={12}/> : <Hash size={12}/>}
                          <span>{triggerType === '@' ? 'Mention' : 'Tag'}</span>
                      </div>
                      <div className="max-h-48 overflow-y-auto custom-scrollbar p-1">
                          {getFilteredTriggers().map((item) => (
                              <button key={item.id} onClick={() => handleTriggerSelect(item)} className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left">
                                  <div className="shrink-0">{item.icon}</div>
                                  <div className="flex-1 min-w-0">
                                      <div className="font-medium text-gray-900 dark:text-gray-200">{item.label}</div>
                                  </div>
                              </button>
                          ))}
                      </div>
                  </div>
              )}

              <div className="bg-[#f0f4f9] dark:bg-[#1e1f20] rounded-[28px] border border-gray-200 dark:border-[#3c4043] shadow-lg flex flex-col transition-colors focus-within:bg-white dark:focus-within:bg-[#252627] focus-within:border-gray-300 dark:focus-within:border-[#5e5f61]">
                 <div className={`flex items-start w-full px-4 ${settings.denseMode ? 'py-2 min-h-[48px]' : 'py-3 min-h-[56px]'}`}>
                    {showCanvasBadge && (
                        <div className="shrink-0 flex items-center gap-1 bg-[#dde3ea] dark:bg-[#28292a] border border-gray-300 dark:border-[#3c4043] rounded-lg px-2 py-1 mr-2 mt-1 cursor-pointer hover:bg-gray-200 dark:hover:bg-[#333]">
                           <Maximize2 size={12} className="text-gray-500 dark:text-gray-400" />
                           <span className="text-xs text-gray-600 dark:text-gray-300">Canvas</span>
                           <button onClick={() => setShowCanvasBadge(false)} className="ml-1 hover:text-black dark:hover:text-white text-gray-400 dark:text-gray-500"><X size={10}/></button>
                        </div>
                    )}
                    <textarea 
                        ref={inputRef}
                        value={input}
                        onChange={handleInputChange}
                        onKeyDown={(e) => { 
                            if (e.key === 'Escape' && triggerType) setTriggerType(null);
                            if (e.key === 'Enter' && !e.shiftKey && !triggerType) { e.preventDefault(); handleSend(); }
                        }}
                        placeholder="Ask Gemini..."
                        className="flex-1 bg-transparent border-none outline-none text-gray-800 dark:text-[#e3e3e3] placeholder-gray-500 text-base resize-none py-1 max-h-[200px] custom-scrollbar"
                        rows={1}
                        style={{ minHeight: '24px' }}
                    />
                 </div>

                 <div className="flex items-center justify-between px-4 pb-3 pt-1">
                    <div className="flex items-center gap-2">
                        <div className="relative" ref={plusMenuRef}>
                            <button onClick={() => setPlusMenuOpen(!isPlusMenuOpen)} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-gray-900 dark:hover:text-white rounded-full transition-all"><Plus size={18} /></button>
                            {isPlusMenuOpen && (
                                <div className="absolute bottom-14 left-0 w-60 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up">
                                    {[ { icon: <HardDrive size={18} />, label: "Upload files" }, { icon: <ImageIcon size={18} />, label: "Photos" }].map((item, idx) => (
                                        <button key={idx} className="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left"><span className="text-gray-500 dark:text-gray-400">{item.icon}</span><span>{item.label}</span></button>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        {/* 只有在设置中启用 enableTools 才会显示工具按钮 */}
                        {settings.enableTools && (
                            <div className="relative" ref={toolsMenuRef}>
                                <button onClick={() => setToolsMenuOpen(!isToolsMenuOpen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${isToolsMenuOpen ? 'bg-gray-200 dark:bg-[#3c4043] text-black dark:text-white' : 'bg-[#dde3ea] dark:bg-[#28292a] text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-black dark:hover:text-white'}`}><Wrench size={14} /><span>Tools</span></button>
                                {isToolsMenuOpen && (
                                    <div className="absolute bottom-14 left-0 w-64 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up">
                                        {[ { icon: <Globe size={16} />, label: "Deep Research" }, { icon: <Video size={16} />, label: "Create videos" } ].map((item, idx) => (
                                            <button key={idx} className="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] text-gray-700 dark:text-gray-300 text-sm transition-colors text-left"><span className="text-gray-500 dark:text-gray-400">{item.icon}</span><span>{item.label}</span></button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="relative" ref={dropdownRef}>
                            <button onClick={() => setModelDropdownOpen(!isModelDropdownOpen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border ${selectedModel.id === 'thinking' ? 'bg-[#e8f0fe] dark:bg-[#18232c] border-blue-200 dark:border-[#294254] text-blue-700 dark:text-[#a8c7fa]' : 'bg-[#dde3ea] dark:bg-[#28292a] border-transparent text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043]'}`}>
                               {selectedModel.icon}
                               <span>{selectedModel.name}</span><ChevronDown size={12} className="opacity-70" />
                            </button>
                            {isModelDropdownOpen && (
                                <div className="absolute bottom-12 right-0 w-72 bg-white dark:bg-[#252627] border border-gray-200 dark:border-[#3c4043] rounded-2xl shadow-2xl p-2 z-50 flex flex-col gap-1 animate-scale-up origin-bottom-right">
                                    <div className="px-3 py-2 text-xs font-medium text-gray-500">Choose your model</div>
                                    {availableModels.map(model => (
                                        <button key={model.id} onClick={() => { setSelectedModel(model); setModelDropdownOpen(false); }} className="flex items-start gap-3 px-3 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-[#3c4043] transition-colors text-left group/item">
                                            <div className="mt-1">{model.icon}</div>
                                            <div className="flex-1"><div className="flex items-center justify-between"><span className={`text-sm font-medium ${selectedModel.id === model.id ? 'text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300'}`}>{model.name}</span>{selectedModel.id === model.id && <Check size={14} className="text-blue-500 dark:text-blue-400"/>}</div><div className="text-xs text-gray-500 mt-0.5">{model.description}</div></div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                        <button className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#3c4043] hover:text-gray-900 dark:hover:text-white rounded-full transition-colors"><Mic size={20} /></button>
                        <button onClick={handleSend} className={`p-2 rounded-full transition-colors ${input.trim() ? 'bg-blue-600 dark:bg-[#a8c7fa] text-white dark:text-[#0b1219] hover:bg-blue-700 dark:hover:bg-white' : 'bg-[#dde3ea] dark:bg-[#3c4043] text-gray-400 dark:text-gray-500 cursor-not-allowed'}`}><Send size={18} className="ml-0.5" /></button>
                    </div>
                 </div>
              </div>
           </div>
        </div>

        {/* Settings Modal */}
        <SettingsModal 
            isOpen={isSettingsOpen} 
            onClose={() => setSettingsOpen(false)} 
            settings={settings}
            updateSettings={handleUpdateSettings}
        />

      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3c4043; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; height: 0; } to { opacity: 1; height: auto; } }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-scale-up { animation: scaleUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      `}</style>
    </div>
  );
}